
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <title>待办-深信服科技流程平台</title>
    <link href="/Content/css?v=HT92VND5teQk7YYfcugwDPCWk-F1pgVO-y8Hx3RW60g1" rel="stylesheet"/>

    
    <style>
        .layui-layer-setwin .layui-layer-close1 {
            display: none;
        }
    </style>

</head>
<style>
.dropMenu {
    width: 110px;
    background: #fff;
    height: 80px;
    position: absolute;
    top: 54px;
    left: 50%;
    border-radius: 5px;
    box-shadow: 0 0 10px 2px #ddd;
    transform: translate(-50%);
    display: none;
    padding-top: 8px
}
.dropMenu span {
    display: block;
    width: 100%;
    height: 36px;
    line-height: 36px;
    text-align: center;
    font-size: 14px;
}
.dropMenu .block_i {
    position: absolute;
    width: 12px;
    height: 12px;
    background: #fff;
    top: -6px;
    left: 45%;
    transform: rotate(45deg);
}
.dropMenu span:hover {
    color: #66b1ff
}
.technical_support {
    color: #fff;
    font-size: 16px;
    width: 135px;
    font-size: 17px;
    padding-top: 18px !important;
}
a.technical_support:hover {
    background: transparent !important;
    color: #eee;
}
</style>
<body>
    <div class="navbar navbar-static-top navbar-header-box">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/Home/Index">
                    <img src="/Content/Images/logo.png" class="img-responsive" />
                </a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav navbar-menu text-center" id="mainMenu">
                    <li class="active" data-controller=""><a href="/Home/Index">个人</a></li>
                    <li class="ReportGroup" style="display:none;" data-controller="Report"><a href="/Report/StateWF">报表</a></li>
                    <li class="ReportGroup" style="display:none;" data-controller="Search"><a href="/Search/ProcInstSearch">搜索</a></li>
                    <li data-controller="Support"><a href="/Support/UserManual">用户手册</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right navbar-dropdown-menu">
                    <li class="dropdown">
                        <a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown">陆文博（软件测试工程师） <span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="javascript:;" id="topBtnChangePosition">切换身份</a></li>
                            <li><a href="http://w3.sangfor.com" target="_blank">返回门户</a></li>
                            <li><a href="/Support/UserManual">帮助</a></li>
                            <li class="divider"></li>
                            <li>
                                <a href="javascript:;" id="btnLogOff">退出登录</a>
                                <form action="/Account/LogOff" id="logoffForm" method="post" style="display:none;">
                                    <input name="__RequestVerificationToken" type="hidden" value="4dX6vG0l6Z4ucVIKf2strFVZ3Z3KaXNik7d8GAMxzXNjFCuC4WS6UxHlke6EZ1W18FY_cHz7SP3RiiE54SYcwG-AqpvmY6WsapuzUwUqxXKZ86cPTT_G1Larp-gY0QZ8ZGVukeDrJpqE4vatw-q9BpS1bGmlyYZXLpzT892V0jIfyZmhuVUoZ493ghA3Hp1GX6FxExP46S_yNDXsu8ghvJSCWcFbRzmVuq8u-JR8cAa6PHTStQS2oRCXo4Mtx5NDl0WImLvWX6rhs-FMZeF6hOucRvmDMyj01cYIXSF3kGozJ86xmlxuDMwXhsYxAX-7i1li2GXGPHd06Vj8yX86XpMIO244eyQpZvH3Z3WYOJpOifjHuYHhK7Q-3LLqQz6nVFtYiTogNY4PaMGpP-P9IS7ZQx9yw4dRc4a27An48wrCiGBhs7xpHZLwXwaATMK4FDwK-iabzP-RYxMbXCD3uMRG-ARTlsmC8FuuFM3ttkcBSpSI93sUflPmQYJ_rtO1KmE94m4naqw1OAU7-aVjXZL37xd2_LZcZ8Pa9HYU4JCku5nzYV0Je4_sq3mYsoLUqvg_X4a5DOILch8Z0VJe9Bcv_hUaTir96R1wblgQk_E1" />
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right navbar-dropdown-menu" style="position:relative">
                    <li>
                        <a href="javascript:;" class="technical_support">
                            系统帮助
                            <span class="caret dropdown"></span>
                        </a>
                    </li>
                    <div class="dropMenu">
                        <span class="MakeComplaints">我要吐槽</span>
                        <span class="TechnicalSupport">技术支持</span>
                        <i class="block_i"></i>
                    </div>
                </ul>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 container-left bg-white"></div>
            <div class="col-md-10 container-right bg-gray">
                




<div class="nav-content-path">
    <span>个人</span> > <span>定制列表</span> > 软件定制
</div>
<div class="form-group form-horizontal border-s-gray bg-white border-rad-4 search-box">
    <input type="hidden" name="ProcessType" value="RJDZ">
    <input type="hidden" name="UserCode" id="UserCode" value="w10518">
    <div class="row-mb-10 row form-group-sm">
        

        <label class="col-md-1 control-label label-title">项目名称</label>
        <div class="col-md-3">
            <input id="txtPrjName" name="txtPrjName" class="form-control" />
        </div>
        <label class="col-md-1 control-label label-title">销售/申请人</label>
        <div class="col-md-3">
            <input id="txtSales" name="txtSales" class="form-control" />
        </div>
        <label class="col-md-1 control-label label-title">申请日期</label>
        <div class="col-md-3">
            <div class="row">
                <div class="col-md-6 input-group-separate">
                    <input id="txtStartDate" name="txtStartDate" class="form-control input-right-icon" readonly="readonly" />
                    <i class="glyphicon glyphicon-calendar icon-right"></i>
                </div>
                <div class="col-md-6">
                    <input id="txtEndDate" name="txtEndDate" class="form-control input-right-icon" readonly="readonly" />
                    <i class="glyphicon glyphicon-calendar icon-right"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="row-mb-10 row form-group-sm">
        <label class="col-md-1 control-label label-title">客户名称</label>
        <div class="col-md-3">
            <input id="txtCustomerName" name="txtCustomerName" class="form-control" />
        </div>
        <label class="col-md-1 control-label label-title">定制单号</label>
        <div class="col-md-3">
            <input id="txtCustomCode" name="txtCustomCode" class="form-control" />
            <span class="help-block" style="color:red;">（提示：多单号查询用,英文逗号隔开）</span>
        </div>
        <label class="col-md-1 control-label label-title">定制类型</label>
        <div class="col-md-3">
            <select id="dropCustomType" name="dropCustomType" class="selectpicker show-tick form-control">
                <option value="">请选择</option>
                <option value="1">功能定制(转研发)</option>
                <option value="2">页面定制/第三方认证</option>
            </select>
        </div>
    </div>
    <div class="row-mb-10 row form-group-sm">
        <label class="col-md-1 control-label label-title">区域</label>
        <div class="col-md-3">
            <select class="selectpicker show-tick form-control" id="dropArea" name="dropArea" style="height: 100px" multiple data-actions-box="true" data-live-search="true"></select>
        </div>
        <label class="col-md-1 control-label label-title">产品线</label>
        <div class="col-md-3">
            <select id="dropPL" name="dropPL" class="selectpicker show-tick form-control" multiple data-live-search="true"></select>
        </div>
        <label class="col-md-1 control-label label-title">审批状态</label>
        <div class="col-md-3">
            <select id="dropApproveStatus" name="dropApproveStatus" class="selectpicker show-tick form-control">
                <option value="">请选择</option>
                <option value="0">草稿</option>
                <option value="2">审批中</option>
                <option value="5">流程被否决</option>
                <option value="6">审批完成</option>
                <option value="7">流程被撤销</option>
            </select>
        </div>
    </div>
    <!-- 增加查询条件 重点查询 超期查询  -->
    <div class="row-mb-10 row form-group-sm">
        <label class="col-md-1 control-label label-title">审批节点</label>
        <div class="col-md-3">
            <select id="dropApprovePoint" name="dropApprovePoint" class="selectpicker show-tick form-control" multiple data-live-search="true"></select>
        </div>
        <label class="col-md-1 control-label"></label>
        <div class="col-md-3">
            <div class="checkbox check-mr-15 icheck-primary">
                <input type="checkbox" id="ckIsHandling" name="ckIsHandling" />
                <label for="ckIsHandling">待办</label>
            </div>
            <div class="checkbox check-mr-15 icheck-primary">
                <input type="checkbox" id="ckIsHandled" name="ckIsHandled" />
                <label for="ckIsHandled">已办</label>
            </div>
            <div class="checkbox check-mr-15 icheck-primary">
                <input type="checkbox" id="ckIsMine" name="ckIsMine" />
                <label for="ckIsMine">本人发起</label>
            </div>
            <!-- 超期定制 -->
            <div class="checkbox check-mr-15 icheck-primary">
                <input type="checkbox" id="ckIsExceed" name="ckIsExceed" />
                <label for="ckIsExceed">超期</label>
            </div>
        </div>
        
        <label class="col-md-1 control-label label-title">功能描述</label>
        <div class="col-md-3">
            <input id="txtrjdzdes" name="txtrjdzdes" class="form-control" />
        </div>
    </div>
    <!-- 增加查询条件 定制处理结果查询   -->
    <div class="row-mb-10 row form-group-sm">
        <label class="col-md-1 control-label label-title">定制处理结果</label>
        <div class="col-md-3">
            <input id="txtCustomerProcessingResults" name="txtCustomerProcessingResults" class="form-control" />
        </div>
    </div>
    <div class="row form-group-sm">
        <div class="col-md-12 text-right">
            <a class="btn btn-primary btn-onload" onclick="RJDZExportExcel()">
                <i class="glyphicon glyphicon-download-alt"></i>
                <span>导出</span>
            </a>
            <a class="btn btn-primary btn-search" id="btnQuery">
                <i class="glyphicon glyphicon-search"></i>
                <span>查询</span>
            </a>
        </div>
        
    </div>      
</div>
<div class="form-group border-s-gray bg-white border-rad-4 search-result-box">
    <div class="form-horizontal row">
        <div class="col-md-9">
            <label class="control-label">共查出 <strong class="text-danger" id="lblRum">0</strong> 条流程</label>
        </div>
    </div>
    <hr />
    <table class="table table-striped table-bordered table-hover" id="tableProcess"></table>
</div>


            </div>
        </div>
    </div>

    <!--[if lt IE 9]>
        <script src="/Scripts/html5shiv.min.js" type="text/javascript"></script>
        <script src="/Scripts/respond.min.js" type="text/javascript"></script>
    <![endif]-->
    <script type="text/javascript" src="/Scripts/watermark.js?v=01"></script>
    <script src="/bundles/modernizr?v=inCVuEFe6J4Q07A0AcRsbJic_UE5MwpRMNGcOtk94TE1"></script>
<script src="/bundles/jquery?v=6mzb0ZqMuNYyRyraMphRsI-Pkxxu9zBO1Chyn1R5Dbo1"></script>
<script src="/bundles/bootstrap?v=oexQZO5BzuBa-8DfSb3-9EFGx4bfJnCf4jAA9QZWS2k1"></script>

    <script src="/Scripts/layer/layer.js" type="text/javascript"></script>
    <script src="/Scripts/jquery.jgrid.js?v=10"></script>
    <script src="/Scripts/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
    <script src="/bundles/bpm?v=Cp-3WDSF2P3uf6MiWFf_b4qG9xMl2FmY0N1IHqqmdJ81"></script>

    <script type="text/javascript">
        //document.domain = 'sangfor.com';
       // document.domain = '200.200.3.33';
        try {
            document.domain = 'sangfor.com';
        } catch(err) {
            console.log(err);
        }
        //document.domain = '200.200.3.230';
        var SSEApi = 'http://sse.sangfor.com/api/PS_Main.svc';
        //var SSEApi = 'http://200.200.3.230:8003/api/PS_Main.svc';
        $(function () {
            var controller = "DataList".toLowerCase(),
                url = "/DataList/DZ_RJDZDataList".toLowerCase(),
                    actionType = "Persons";

            controller = controller.replace(/(^|\s+)\w/, function (s) {
                return s.toUpperCase();
            });
	    setTimeout(function(){
		var vUserName = "陆文博";
            	var eNumber =  "w10518"
            	if(vUserName+eNumber) {
                 	watermark.init({ watermark_txt: vUserName + eNumber ,
                            watermark_rows:3000,
                            watermark_cols:8,
                            watermark_alpha:0.15,
                            watermark_x_space:100,
                            watermark_y_space:140,
                            watermark_fontsize:'26px' })
            	}
	    },100)
            switch (controller) {
                case "Report":
                    actionType = "Reports";
                    break;
                case "Search":
                    actionType = "Searchs";
                    break;
                case "Support":
                    actionType = "Helps";
                    break;
                default:
                    controller = "";
                    break;
            }

            $("#mainMenu li").removeClass("active");
            $("#mainMenu li[data-controller=\"" + controller + "\"]").addClass("active");
	        // $('.technical_support').on('mousemove', function() {
            //     // $('.technical_support').css('background', '#035B9B')
            //     $('.dropMenu').css('display', 'block')
	        // })
		    $('.technical_support').on('mouseout', function() {
                // $('.dropMenu').css('display', 'none')
			    $('.technical_support').css('background', 'transparent')
			    $('.technical_support').css('color', '#eee')
	        })
	        $('.technical_support').on('click', function() {
                // window.open('/Content/tech.html', '_blank')
                if($('.dropMenu').css('display') == 'block') {
                    $('.dropMenu').css('display', 'none')
                } else {
                    $('.dropMenu').css('display', 'block')
                }
			// $('.technical_support').css('background', 'transparent')
            })
			 $('.dropMenu').on('mousemove', function() {
                // $('.technical_support').css('background', '#035B9B')
                $('.dropMenu').css('display', 'block')
	        })
	        $('.dropMenu').on('mouseout', function() {
                // $('.technical_support').css('background', '#035B9B')
                $('.dropMenu').css('display', 'none')
	        })
            $('.dropMenu').on('click', '.MakeComplaints', function() {
                window.open('http://feedback.sangfor.org/feedback/index/index', '_Blank')
            })
            $('.dropMenu').on('click', '.TechnicalSupport', function() {
                window.open('http://w3.sangfor.com/html/tech.html', '_Blank')
            })

            // 切换身份
            $("#topBtnChangePosition").on("click", function () {
                layer.open({
                    type: 2,
                    skin: 'layui-layer-rim',
                    title: false,
                    area: ['350px', '200px'],
                    content: '/Dialog/ChangePosition'
                });
            });

            // 退出登录
            $("#btnLogOff").on("click", function () {
                $("#logoffForm").submit();
            });

            getMenus(actionType, url);
            IsReportGroup();
        });

        //是否显示报表搜索
        function IsReportGroup() {
            $.get("/Home/IsReportGroup", {}, function (data) {
                if (data.ReturnData == 'True')
                    $('.ReportGroup').show();
            })
        }


        // 获取左侧菜单
        function getMenus(name, url) {
            var menu = "",
                selMenu = "", // 选中左侧菜单
                ulItem = "";

            $.get("/Home/GetMenus", "", function (data) {
                $.each(data[name], function (i, o) {
                    ulItem = o.title == "常用模板" ? 'id="ulCommon"' : "";

                    menu += '<h5 class="font-weight-b">' + o.title + '</h5>';
                    menu += '<ul class="nav nav-pills nav-stacked row" ' + ulItem + '>';
                    $.each(o.child, function (j, m) {
                        // if (m.text == "快速发放") return; // 屏蔽快速发放
                        selMenu = m.url.toLowerCase() == url.replace('myzdsh', 'myksff') ? ' class="active"' : "";

                        menu += '<li' + selMenu + '>';
                        menu += '<a href="' + m.url + '">';
                        menu += '<i class="icon-check-empty"></i>' + m.text;

                        if (m.text == "待办") {
                            menu += ' <span class="badge bg-orange" id="LMAwaitCount">0</span>';
                        }

                        if (m.text == "快速发放") {
                            menu += ' <span class="badge bg-orange hide" id="LMKSFFCount">0</span>';
                        }

                        if (m.text == "消息中心") {
                            menu += ' <span class="badge bg-orange" id="LMMsgCount">0</span>';
                        }

                        menu += '</a>';
                        menu += '</li>';
                    });
                    menu += '</ul>';
                });

                $(".container-left").html(menu);

                if (name == "Persons") {
                    // 获取待办数
                    getAwaitCount();

                    // 获取快速发放数
                    getKSFFCount(); // 注释屏蔽快速发放

                    // 获取消息中心数
                    getMsgCount();

                    // 获取常用模板
                    $.get("/Home/GetCommonProcess", "", function (data) {
                        var menu = '', json = eval("(" + data.ReturnData + ")");
                        $.each(json, function (i, o) {
                            menu += '<li>';
                            menu += '<a href="' + o.StartUrl + '" target="_blank" processcode="' + o.ProcessCode + '">';
                            menu += '<i class="icon-check-empty"></i>' + o.ProcessName;
                            menu += '</a>';
                            menu += '</li>';
                        });
                        $("#ulCommon").html(menu);
                    }, "json");
                }
            }, "json");
        }

        // 获取待办数
        function getAwaitCount() {
            $.get("/Home/GetWorks", "", function (data) {
                var count = data.ReturnData == null ? 0 : data.ReturnData;
                $("#LMAwaitCount").text(count);
            }, "json");
        }

        // 获取快速发放数
        function getKSFFCount() {
            $.get(SSEApi + '/xxx', "", function (data) {
                var count = data.ReturnData == null ? 0 : data.ReturnData;
                if (count) {
                    $("#LMKSFFCount").removeClass('hide').text(count);
                }
            }, "json");
        }

        // 获取消息中心数
        function getMsgCount() {
            $.get("/Home/GetMsgCount", "", function (data) {
                var count = data.ReturnData == null ? 0 : data.ReturnData;
                $("#LMMsgCount").text(count);
            }, "json");
        }
    </script>
    
    <script>
        var hasDZLrights = false
        $(function () {
            var $tableProcess = $("#tableProcess");
            // 初始化起始日期选择
            $.initDateGroupOption({
                startEl: "txtStartDate",
                endEl: "txtEndDate"
            });

            $("#btnQuery").on("click", function () {
                queryData($tableProcess);
            });

            $('.search-result-box').on('click', '.end', processEnd)
            initAreaList();
            initPLList();
            initApprovePoint();
            queryData($tableProcess);
            fetchPermission()
        });

        function processEnd() {
            var src = $(this).data('code')
            var sn = src.split(',')[0];
            var wfstep = src.split(',')[1];
            var commentInfo = src.split(',')[2];
            var procInstId = src.split(',')[3];
            var activeName = src.split(',')[4];
            var rjdznew = src.split(',')[5];
            var loginName = src.split(',')[6];
            //var type  = $(this).is('.jump')?'jumpProcess':'endProcess'
            var url=''
            if(rjdznew == "1"){
                url = '/RJDZNEW/endProcess'
            } else {
                url = '/RJDZ/endProcess'
            }
            var fetchFn = function (index) {
                $.ajax({
                    url: url,
                    type:'post',
                    data:{
                        sn: sn, wfstep: wfstep, commentInfo: commentInfo, procInstId: procInstId, activeName: activeName, loginName: loginName
                    },
                    success: function (data) {
                        var data = data && JSON.parse(data)
                        layer.close(index)
                        if(data.result) {
                            queryData($("#tableProcess"))
                        }
                    }
                })
            }
            layer.confirm('确定终止电子流',{
                    btn: ['确定', '取消'] //按钮
            }, fetchFn)
        }

        //拉取权限
        function fetchPermission() {
            var eNumber =  "w10518"
            $.ajax({
                url:'/Datalist/checkExport',
                type:'post',
                data:{
                    code:eNumber
                },
                success:function(data) {
                    var data = data && JSON.parse(data)
                    if(!data.result) {
                        $('.btn-onload').remove()
                    }
                }
            })

            $.ajax({
                url:'/Datalist/checkProcess',
                type:'post',
                data:{
                    code:eNumber
                },
                success:function(data) {
                    var data = data && JSON.parse(data)
                    hasDZLrights = data.result || false
                }
            })
        }
        //加载区域
        function initAreaList() {
            $.get("/DataList/GetParams", { paramType: "Area" }, function (data) {
                if (data != null) {
                    var arr = eval("(" + data + ")");
                    var html = "";
                    var group = {};
                    var mapGroupName = {};
                    for (var i = 0; i < arr.length; i++) {
                        if (group['a' + arr[i]['GroupID']] == undefined) {
                            group['a' + arr[i]['GroupID']] = [];
                            mapGroupName['a' + arr[i]['GroupID']] = arr[i]['GroupName'];
                        }
                        group['a' + arr[i]['GroupID']].push({ AreaID: arr[i]['AreaID'], AreaName: arr[i]['AreaName'] });
                    }
                    for (p in group) {
                        html += '<optgroup label="' + mapGroupName[p] + '">'
                        for (var i = 0; i < group[p].length; i++) {
                            html += '<option data-tokens="' + mapGroupName[p] + ',' + group[p][i]["AreaName"] + '" value="' + group[p][i]["AreaID"] + '">' + group[p][i]["AreaName"] + '</option>';
                        }
                        html += '</optgroup>'
                    }
                    $("#dropArea").html(html).selectpicker("refresh");
                }

            });
        }
        //加载审批节点
        function initApprovePoint() {
            $.get("/DataList/GetParams", { paramType: "ApprovePoint" }, function (data) {
                var html = "";
                if (data != null) {
                    var options = eval("(" + data + ")");
                    for (var i = 0; i < options.length; i++) {
                        html += "<option value=" + options[i]["Code"] + ">" + options[i]["Name"] + "</option>";
                    }
                }
                $("#dropApprovePoint").html(html).selectpicker("refresh");
            });
        }
        //加载产品线
        function initPLList() {
            $.get("/DataList/GetParams", { paramType: "PL" }, function (data) {
                var html = "<option value=''>请选择</option>";
                if (data != null) {
                    var options = eval("(" + data + ")");
                    for (var i = 0; i < options.length; i++) {
                        html += "<option value=" + options[i]["PLCode"] + ">" + options[i]["PLName"] + "</option>";
                    }
                }
                $("#dropPL").html(html).selectpicker("refresh");
            });
        }
        // 获取流程
        function getProcess(categoryId) {
            $.get("/Home/GetddlProcessData", { categoryId: categoryId }, function (data) {
                var option = '';
                $.each(data, function (i, o) {
                    option += '<option value="' + o.ProcessCode + '">' + o.ProcessName + '</option>';
                });
                $("#ddlProcess").html(option)
                                .selectpicker('refresh'); // 刷新组件
            }, "json");
        }

        // 查询
        function queryData($table) {
            $table.jgrid({
                url: '/DataList/GetDZDataList',
                dataType: "json",
                pageIndex: 1,
                pageCount: 10,
                pageAlign: "right",
                isMultiSelect: true,
                params: [
                    { name: "CustomerName", value: $("#txtCustomerName").val() },
                    { name: "PrjName", value: $('#txtPrjName').val() },
                    { name: "ApprovePoint", value: $('#dropApprovePoint').val() },
                    { name: "AreaID", value: $('#dropArea').val() },
                    { name: "CustomCode", value: $('#txtCustomCode').val() },
                    { name: "ProcessType", value: 'RJDZ' },
                    { name: "PL", value: $('#dropPL').val() },
                    { name: "ApproveStatus", value: $('#dropApproveStatus').val() },
                    { name: "CustomType", value: $('#dropCustomType').val() },
                    { name: "Applicant", value: $('#txtApplicant').val() },
                    { name: "CurrentLoginName", value: 'w10518' },
                    { name: "IsHandling", value: $('#ckIsHandling').is(":checked") },
                    { name: "IsHandled", value: $('#ckIsHandled').is(":checked") },
                    { name: "IsMine", value: $('#ckIsMine').is(":checked") },
                    //超期
                    { name: "IsExceed", value: $('#ckIsExceed').is(":checked") },
                    { name: "BeginDate", value: $('#txtStartDate').val() },
                    { name: "EndDate", value: $('#txtEndDate').val() },
                    { name: "Sales", value: $('#txtSales').val() },
                    { name: "txtrjdzdes", value: $('#txtrjdzdes').val() },
                    //定制处理结果
                    { name: "txtCustomerProcessingResults", value: $('#txtCustomerProcessingResults').val() }
                ],
                colModel: [
                    {
                        display: '定制单号', name: "RjdzCode", width: 135, formatText: function (data) {
                            var html = '<a href="###" onclick="OpenDZPage(\'' + data.EncryptProcInstID + '\',\'' + data.GUID + '\',\'' + data.IsApprove + '\',\'' + 'w10518' + '\',\'' + data.RJDZNEW + '\')">' + data.RjdzCode + '</a>';
                            return html;
                        }
                    },
                    { display: '区域', name: 'AreaName', width: 100, align: 'center' },
                    { display: '销售', name: 'UserName', width: 100, align: 'center' },
                    {
                        display: "客户名称", name: "CusName", width: 130, align: 'center'
                    },
                    {
                        display: '定制功能描述', width: 150, name: 'RjdzMemo', formatText: function (data) {
                            var html
                            if (data.RjdzMemo.length > 100) {
                                html = '<div style="width:150px" title="' + data.RjdzMemo + '">' + data.RjdzMemo.substr(0, 100) + '...<a href="javascript:void(0)" onclick="ShowContent(this)">更多</a></div>';
                            }
                            else {
                                html = '<div style="width:150px" title="' + data.RjdzMemo + '">' + data.RjdzMemo + '</div>';
                            }
                            return html;
                        }

                    },
                    { display: '预签金额', width: 50, name: 'AdvanceAmount', align: 'center' },
                    { display: '定制类型', width: 100, name: 'RjdzTypeName', align: 'center' },
                    { display: '申请时间', width: 100, name: 'ApplyDate', align: 'center' },
                    { display: '申请人', width: 100, name: 'AddByName', align: 'center' },
                    {
                        display: "当前节点", name: "CurrentPointName", width: 70, align: 'center'
                    },
                    { display: '当前处理人', width: 100, name: 'CurrentApprover', align: 'center' },
                    //首页表格增加3列：定制处理结果,研发预计提交市场时间,最新交付日期
                    { display: '定制处理结果', width: 200, name: 'CustomerProcessingResults', align: 'center' },
                    { display: '研发预计提交市场时间', width: 100, name: 'PlannedDeliveryTime', align: 'center' },
                    {
                        display: '最新交付日期', width: 100, name: 'LatestDeliveryDate', formatText: function (data) {
                            //当研发最新计划超出计划交付时间，底色变红
                            var html;
                            if (data.LatestDeliveryDate != null && data.PlannedDeliveryTime != null && data.LatestDeliveryDate > data.PlannedDeliveryTime) {
                                html = '<div style="width:100px;background-color:red" >' + data.LatestDeliveryDate + '</div>';
                            }
                            else if (data.LatestDeliveryDate == null) {
                                html = '<div style="width:100px" ></div>';
                            }else{
                                html = '<div style="width:100px" >' + data.LatestDeliveryDate + '</div>';
                            }
                            return html;
                        }

                    },
                    {
                        display:'操作',name:'',width:100,formatText:function(data) {
                            var showBtns = data.ApproveStatus == '2' && hasDZLrights
                            return showBtns ? '<a href="javascript:;" class="end" data-code="' + data.SN + ',' + data.CurrentPointCode + ',' + data.WFMemo + ',' + data.ProcInstID + ',' + data.CurrentPointName + ',' + data.RJDZNEW +','+ 'w10518' +'" style="color:red">终止</a>' : '<span>-</span>'
                        }
                    }
                ],
                onSuccess: function (data) {
                    $("#lblRum").text(data.total);
                    $.initiCheck(); // 初始化iCheck
                }
            });
            }

            var pageindex = 0, // 当前索引
                selecteds = [];
            function ShowContent(obj) {
                var content = $(obj).parent().attr('title');
                $(obj).parent().html(content);
            }
            function ApproveOneByOne() {
                pageindex = 0;
                selecteds = $('#tableProcess').jgrid('getSelectRowsData');

                if (selecteds.length < 1) {
                    layer.msg('请选择需要审批的流程', function () {
                        //关闭后的操作
                    });
                    return;
                }
                OpenDialog();
            }

            function OpenDialog() {
                var index = layer.open({
                    type: 2,
                    title: '逐单审批',
                    shadeClose: true,
                    shade: false,
                    maxmin: true,
                    content: selecteds[pageindex].ApproveUrl,
                    area: ['893px', '600px'],
                    btn: ['上一单', '下一单', '关闭'],
                    yes: function (index, layero) {
                        if (pageindex - 2 < 0) layer.msg('已经在第一个');
                        else {
                            layer.close(index);
                            pageindex = pageindex - 2;
                            OpenDialog();
                        }
                    }, btn2: function (index, layero) {
                        if (pageindex == selecteds.length) { layer.msg('已经在最后一个'); }
                        else { layer.close(index); OpenDialog(); }

                    }, btn3: function (index, layero) {
                        //$('#grid').datagrid('reload');
                        layer.close(index);
                        window.document.location.reload();

                    }
                    , cancel: function () {
                        return false;
                    }

                });
                layer.full(index);
                pageindex++;
            }
            function OpenDZPage(pid, guid, isApprove, usercode, rjdznew) {
               var url = "";
               if (isApprove != '1' && isApprove != '2') {
                    if(rjdznew == "1"){
                        url = 'http://200.200.0.133:8030/Forms/RJDZNEW/RJDZNEW/View?ProcInstId=' + pid;
                        //url = 'http://192.200.248.228:8313/Forms/RJDZNEW/RJDZNEW/View?ProcInstId=' + pid;
                        //url = 'http://200.200.4.131:8030/Forms/RJDZNEW/RJDZNEW/View?ProcInstId=' + pid;
                    } else {
                        url = 'http://200.200.0.133:8030/Forms/RJDZ/RJDZ/View?ProcInstId=' + pid;
                        //url = 'http://192.200.248.228:8313/Forms/RJDZ/RJDZ/View?ProcInstId=' + pid;
                        //url = 'http://200.200.4.131:8030/Forms/RJDZ/RJDZ/View?ProcInstId=' + pid;
                    }
                }
                else {
                    $.ajax({
                        type: "post",
                        url: '/DataList/GetSN',
                        data: { guid: guid, usercode: usercode },
                        async: false,
                        success: function (data) {
                            if (isApprove == '2') {
                                if (rjdznew == "1") {
                                    url = 'http://200.200.0.133:8030/Forms/RJDZNEW/RJDZNEW/Start?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://192.200.248.228:8313/Forms/RJDZNEW/RJDZNEW/Start?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://200.200.4.131:8030/Forms/RJDZNEW/RJDZNEW/Start?SN=' + data + '&GUID=' + guid;
                                } else {
                                    url = 'http://200.200.0.133:8030/Forms/RJDZ/RJDZ/Start?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://192.200.248.228:8313/Forms/RJDZ/RJDZ/Start?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://200.200.4.131:8030/Forms/RJDZ/RJDZ/Start?SN=' + data + '&GUID=' + guid;
                                }
                            }
                            else {
                                if (rjdznew == "1") {
                                    url = 'http://200.200.0.133:8030/Forms/RJDZNEW/RJDZNEW/Processing?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://192.200.248.228:8313/Forms/RJDZNEW/RJDZNEW/Processing?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://200.200.4.131:8030/Forms/RJDZNEW/RJDZNEW/Processing?SN=' + data + '&GUID=' + guid;
                                } else {
                                    url = 'http://200.200.0.133:8030/Forms/RJDZ/RJDZ/Processing?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://192.200.248.228:8313/Forms/RJDZ/RJDZ/Processing?SN=' + data + '&GUID=' + guid;
                                    //url = 'http://200.200.4.131:8030/Forms/RJDZ/RJDZ/Processing?SN=' + data + '&GUID=' + guid;
                                }
                            }
                        }
                    });

                }                
                window.open(url, '_blank');
            }

        //导出软件定制数据
        function RJDZExportExcel() {
            var data = {
                CustomerName: $("#txtCustomerName").val(),
                PrjName: $('#txtPrjName').val(),
                ApprovePoint: $('#dropApprovePoint').val(),
                AreaID: $('#dropArea').val(),
                CustomCode: $('#txtCustomCode').val(),
                ProcessType: 'RJDZ',
                PL: $('#dropPL').val(),
                ApproveStatus: $('#dropApproveStatus').val(),
                CustomType: $('#dropCustomType').val(),
                //Applicant: $('#txtApplicant').val(),
                CurrentLoginName: 'w10518',
                IsHandling: $('#ckIsHandling').is(":checked"),
                IsHandled: $('#ckIsHandled').is(":checked"),
                IsMine: $('#ckIsMine').is(":checked"),
                //超期
                IsExceed: $('#ckIsExceed').is(":checked"),
                BeginDate: $('#txtStartDate').val(),
                EndDate: $('#txtEndDate').val(),
                Sales: $('#txtSales').val(),
                txtrjdzdes: $('#txtrjdzdes').val(),
                txtCustomerProcessingResults: $('#txtCustomerProcessingResults').val()
            };
            var formatObj = function (obj) {
                return Object.keys(obj).map(function (key) {
                    if (obj[key] == null) {
                        return key + '=';
                    } else {
                        return key + '=' + obj[key];
                    }
                }).join('&')
            }
            console.log(formatObj(data));
            iframeSrc = '/DataList/RJDZExportExcel?' + formatObj(data);
            var iframe = $('<iframe src="' + iframeSrc + '" style="display:none"><iframe>');
            console.log(iframeSrc);
            iframe[0].onload = function () {
                iframe.remove();
            }
            iframe.appendTo($('body'));
        }
    </script>

</body>
</html>
